# =============================================================================
# StigmergiAgentic — Docker Compose services
# Sprint 2.5 — Containerized test & migration execution
# =============================================================================
#
# Usage:
#   docker compose run --rm test              # Run full test suite
#   docker compose run --rm test-cov          # Tests + coverage report
#   REPO=<url|path> REPO_REF=<tag|branch|sha> docker compose run --rm migrate
#   docker compose run --rm shell             # Interactive shell
#

services:
  # ---- Test runner (default) ----
  test:
    build: .
    command: [ "pytest", "tests/", "-v" ]
    env_file:
      - .env
    volumes:
      - ./pheromones:/app/pheromones

  # ---- Test runner with coverage ----
  test-cov:
    build: .
    command: [ "pytest", "tests/", "--cov", "--cov-report=term-missing", "-v" ]
    env_file:
      - .env
    volumes:
      - ./pheromones:/app/pheromones

  # ---- Migration runner ----
  migrate:
    build: .
    environment:
      REPO: ${REPO:-}
      REPO_REF: ${REPO_REF:-}
    command:
      - /bin/sh
      - -c
      - |
        set -e
        CMD="python main.py --repo \"$${REPO:-https://github.com/example/py2-repo}\" --config stigmergy/config.yaml"
        if [ -n "$${REPO_REF:-}" ]; then
          CMD="$$CMD --repo-ref \"$${REPO_REF}\""
        fi
        eval "$$CMD"
    env_file:
      - .env
    volumes:
      - ./pheromones:/app/pheromones
      - target_repo_data:/app/target_repo
      - ./metrics/output:/app/metrics/output

  # ---- Interactive shell ----
  shell:
    build: .
    command: [ "/bin/bash" ]
    stdin_open: true
    tty: true
    env_file:
      - .env
    volumes:
      - ./pheromones:/app/pheromones

volumes:
  target_repo_data:
