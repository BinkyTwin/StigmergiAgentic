# 004 Sprint 2.5 Docker Infrastructure for Tests & Migrations

**Date** : 2026-02-12

**Status** : Accepted

**Context** : Lotfi + Antigravity (Claude)

---

## Context

Sprints 1 and 2 validate tests locally via `uv run pytest`. This works well for development but introduces host-dependence: different Python builds, OS-level differences (POSIX `fcntl.flock`), and missing system packages can cause test divergence across machines.

Sprint 2.5 addresses this by containerizing the test and migration execution in Docker, ensuring identical results regardless of the host environment. This also prepares for CI pipeline integration in later sprints.

## Alternatives Considered

### Alternative 1: Local-only execution (status quo)

**Description** : Keep all test and migration execution via `uv run` on the developer's host machine.

**Advantages** :
- No added complexity
- Fastest iteration loop

**Drawbacks** :
- Host-dependent results (macOS vs Linux, Python build differences)
- `fcntl.flock` is POSIX-only — may fail on non-POSIX hosts
- No CI readiness
- Harder to reproduce for thesis jury

---

### Alternative 2: Docker-only execution (replace uv)

**Description** : Mandate all execution through Docker, remove `uv` workflow entirely.

**Advantages** :
- Single execution path, maximum consistency
- Full isolation

**Drawbacks** :
- Slower iteration during development
- Loses lightweight `uv run` for quick local checks
- Overhead for agents (Codex) that interact best with local tooling

---

### Alternative 3: Docker for tests + migration, preserve uv for local dev (Chosen)

**Description** : Add Docker as a reproducible execution layer. Keep `uv run` for fast local development. Both paths should produce identical results.

**Advantages** :
- Reproducibility via Docker when needed (CI, thesis evidence)
- Fast iteration via `uv run` during development
- CI-ready without further changes
- Host-independent test evidence for thesis annex

**Drawbacks** :
- Two execution paths to maintain
- Docker build time on first run

---

## Decision

**Chosen option** : Alternative 3

**Rationale** :
- Balances reproducibility (thesis constraint) with development velocity
- Preserves the `uv` workflow established in Sprint 1 for fast local iteration
- Docker layer provides host-independent execution for CI and formal validation
- Aligns with scientific reproducibility goals (identical results across environments)

## Consequences

### Positive
- Test results are reproducible across any machine with Docker
- CI pipeline integration requires minimal additional work
- Thesis jury can reproduce results without matching the developer's exact environment
- `fcntl.flock` (POSIX) is guaranteed to work on the Linux-based Docker image

### Negative
- Initial Docker build adds ~30s overhead
- Two execution paths (Docker and local) to maintain in documentation
- Docker Desktop required on macOS

### Code Impact
- Added: `Dockerfile` (multi-stage: builder with uv + runner with git)
- Added: `docker-compose.yml` (services: test, test-cov, migrate, shell)
- Added: `.dockerignore` (excludes .venv, .git, caches, docs)
- Added: `Makefile` (Docker and local command shortcuts)
- Modified: `CLAUDE.md`, `AGENTS.md` (Docker commands section)
- Modified: `consigne/plan_poc_stigmergique.md` (Sprint 2.5 entry)

### Methodology Impact
- Strengthens reproducibility evidence for the thesis
- Establishes a CI-ready infrastructure for Sprint 3+
- Docker-based test runs can serve as formal validation evidence

## Validation

**Success criteria** :
1. [x] Docker image builds without errors
2. [x] `docker compose run --rm test` reproduces the same test results as `uv run pytest tests/ -v`
3. [x] `make docker-test` shortcut works
4. [x] Documentation updated (ADR, INDEX, CLAUDE.md, AGENTS.md, construction_log, plan_poc)

**Executed tests** :
```bash
docker compose build
docker compose run --rm test
make docker-test
```

**Implementation result** :
- [x] All criteria validated
- [x] Decision confirmed

## References

- `consigne/plan_poc_stigmergique.md`
- Sprint 1 ADR (20260210-sprint1-environment-medium.md) — established uv as local runtime
- Sprint 2 ADR (20260210-sprint2-agents-unitaires.md) — test suite baseline

## Metadata

- **Created by** : Antigravity (Claude)
- **Validated by** : Auto-validated with Docker test evidence
- **Version** : 1.0
- **Last modified** : 2026-02-12
